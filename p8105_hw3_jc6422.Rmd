---
title: "p8105_hw3_jc6422"
author: "Jianing Chen"
date: "2024-10-09"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Problem 1

load the data from packages

```{r}
library(p8105.datasets)
library(tidyverse)
library(ggplot2)
library(patchwork)
data("ny_noaa")
```

data cleaning

```{r}
ny_noaa_df = ny_noaa |>
  mutate(
    date = as.Date(date),
    year = year(date),
    month = month(date),
    day = day(date),
    tmax = as.numeric(tmax) / 10,  
    tmin = as.numeric(tmin) / 10,  
    prcp = as.numeric(prcp) / 10,
    snow = snow
  ) %>%
  filter(!is.na(tmax) & !is.na(tmin) & !is.na(snow) & !is.na(prcp)) 

ny_noaa_df
```

This data has `r nrow(ny_noaa_df)` rows and `r ncol(ny_noaa_df)` columns. The variables are `r names(ny_noaa_df)`.

Make a two-panel plot showing the average max temperature in January and in July in each station across years.

```{r}
january = ny_noaa_df %>% 
  filter(month == 1)

july = ny_noaa_df %>% 
  filter(month == 7)

jan_avg_tmax = january %>% 
  group_by(id, year) %>% 
  summarize(avg_tmax = mean(tmax, na.rm = TRUE))%>%
  mutate(month="January")

jul_avg_tmax = july %>% 
  group_by(id, year) %>% 
  summarize(avg_tmax = mean(tmax, na.rm = TRUE))%>%
  mutate(month="July")

combined_data = bind_rows(jan_avg_tmax, jul_avg_tmax)

ggplot(combined_data, aes(x = as.numeric(year),y=avg_tmax)) +
  geom_point(aes( color = month)) +
  labs(title = "Average Max Temperature in January and July", 
       x = "Year", 
       y = "Average Max Temperature") +
  facet_grid(month~.) +
  scale_color_manual(values = c("January" = "blue", "July" = "red")) +
  theme_minimal()

```

Observations:

The blue plot represents the distribution of average maximum temperatures in January.
This structure suggests relatively stable temperatures with some fluctuation over time.

The red plot represents the distribution of average maximum temperatures in July. This structure is also relatively stable. There is an outlier in 1988.

Make a two-panel plot showing :

(i) tmax vs tmin for the full dataset 
(ii) make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.

```{r}
p1 = ggplot(ny_noaa_df, aes(x = tmin, y = tmax)) +
  geom_bin2d(bins = 30) +
  scale_fill_viridis_c() +
  labs(title = "Tmax vs Tmin", x = "Minimum Temperature (Tmin)", y = "Maximum Temperature (Tmax)") +
  theme_minimal()

snow_filtered = ny_noaa_df %>%
  filter(snow > 0 & snow < 100)

p2 = ggplot(snow_filtered, aes(x = snow, fill = factor(year))) +
  geom_density(alpha = 0.5) +  
  labs(title = "Density of Snowfall (0 < Snow < 100) by Year", x = "Snowfall (cm)", y = "Density") +
  theme_minimal()

combined_plot = p1 / p2

combined_plot
```

## Problem 2

Load and clean the datasets.

```{r}
accel = read_csv("data/nhanes_accel.csv")
covar = read_csv("data/nhanes_covar.csv",skip = 4) 
colnames(covar) = c("SEQN", "sex", "age", "BMI", "education")
merged_data = accel %>%
  left_join(covar, by = "SEQN") %>%
  filter(age >= 21, !is.na(education), !is.na(sex), !is.na(age))

merged_data
```

Create a table for the number of men and women in each education category:

```{r}
merged_data = merged_data %>%
  mutate(
    sex = case_when(
      sex == 1 ~ "Male",
      sex == 2 ~ "Female"
    ),
    education = case_when(
      education == 1 ~ "Less than high school",
      education == 2 ~ "High school equivalent",
      education == 3 ~ "More than high school"
    )
  )
table = merged_data %>%
  group_by(education, sex) %>%
  summarise(count = n()) %>%
  pivot_wider(names_from = sex, values_from = count, values_fill = 0)

table

```

The table represents the distribution of men and women across different education categories. In the category "Less than high school," there are 28 men and 29 women. For "More than high school," there are 56 men and 59 women, and for "high school equivalent", there are 36 men and 23 women. This suggests a relatively balanced gender distribution across education levels.

Create a visualization of the age distributions for men and women in each education category.

```{r}
ggplot(merged_data, aes(x = age, fill = sex)) +
  geom_histogram(binwidth = 2, position = "dodge") +
  facet_wrap(~education) +
  labs(
    title = "Age Distribution by Education Level and Gender",
    x = "Age",
    y = "Count",
    fill = "Gender"
  ) +
  theme_minimal()

```

The histogram represents the distribution of ages for both men and women across different education categories. The "High school equivalent" group shows a broader age range, with a higher number of individuals in older age categories.The "Less than high school" group has a more dispersed age distribution with fewer individuals, but males tend to dominate in the older age categories. The "More than high school" education group is clearly the largest, with a more defined clustering of individuals in middle age, which could indicate that those with higher education tend to be younger in this dataset. Gender representation is fairly balanced across the categories, although there are slight differences in certain age brackets within each education group.

Make plots to compare men to women and have separate panels for each education level.

```{r}
total_activity_data = merged_data %>%
  mutate(total_activity = rowSums(select(., starts_with("min")), na.rm = TRUE)) %>%
  group_by(SEQN, sex, age, education) %>%
  summarise(total_activity = sum(total_activity, na.rm = TRUE)) %>%
  ungroup()

ggplot(total_activity_data, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE) + # Using loess for a smooth trend line
  facet_wrap(~education) +
  labs(
    title = "Total Activity vs Age by Education Level and Gender",
    x = "Age",
    y = "Total Activity",
    color = "Gender"
  ) +
  theme_minimal()

```

All of the three plots show that total physical activity generally decreases with age for both men and women across all education levels. 

Women generally exhibit higher activity levels than men in middle age (30-50), while men experience a steeper decline in activity after age 60 compared to women. 

The group with more education shows more consistent activity patterns in middle age, while those with less education display a sharper drop in activity from age 40 onwards.

Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex.

```{r}
long_data = merged_data %>%
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               values_to = "activity") %>%
  mutate(minute = as.numeric(str_remove(minute, "min")),
          sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
    education = factor(education, levels = c(1, 2, 3), 
                       labels = c("Less than high school", "High school equivalent", "More than high school"))
  )

ggplot(long_data, aes(x = minute, y = activity, color = sex)) +
  geom_line(alpha = 0.5) +  # Light lines to show individual participants' activity
  geom_smooth(se = FALSE, method = "loess") +  # Smooth trend to highlight overall activity patterns
  facet_wrap(~education) +  # Separate panels for each education level
  labs(
    title = "24-Hour Activity Time Course by Education Level and Gender",
    x = "Time (minutes from midnight)",
    y = "Activity",
    color = "Gender"
  ) +
  theme_minimal()

```

Higher education levels correlate with more sustained physical activity throughout the day, especially in the evening.

The graph shows clear daily cycles of physical activity, with higher levels in the morning and evening and a dip in the early afternoon.

The trend line suggests potential gender differences in physical activity patterns.

## Problem 3

Load and clean the datasets

```{r}
jan_2020 = read_csv("data/citibike/Jan 2020 Citi.csv") %>%
  mutate(year = 2020, month = "January")
jan_2024 = read_csv("data/citibike/Jan 2024 Citi.csv") %>%
  mutate(year = 2024, month = "January")
july_2020 = read_csv("data/citibike/July 2020 Citi.csv") %>%
  mutate(year = 2020, month = "July")
july_2024 = read_csv("data/citibike/July 2024 Citi.csv") %>%
  mutate(year = 2024, month = "July")
citi_bike_data = bind_rows(jan_2020, jan_2024, july_2020, july_2024)
```

This data has `r nrow(citi_bike_data)` rows and `r ncol(citi_bike_data)` columns. The variables are `r names(citi_bike_data)`.


